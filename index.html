<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compartilhamento de Tela entre Dispositivos</title>
  <script type="module">
    // Importação dos módulos do Firebase v9+ com a nova sintaxe modular
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
  
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAWhfaY2Adp4YJGwvITWTGHP-7zOLNfiGI",
      authDomain: "sandalias-retro-9f0c6.firebaseapp.com",
      databaseURL: "https://sandalias-retro-9f0c6-default-rtdb.firebaseio.com",
      projectId: "sandalias-retro-9f0c6",
      storageBucket: "sandalias-retro-9f0c6.appspot.com",
      messagingSenderId: "786208752798",
      appId: "1:786208752798:web:193f76bbbf5ac4ef27678f",
      measurementId: "G-XGVHLX01EB"
    };

    // Inicializa o Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Variáveis Globais
    let peerConnection;
    const localStream = new MediaStream();
    const remoteStream = new MediaStream();

    // Configuração dos servidores STUN/TURN
    const iceServers = [
      {
        urls: "stun:stun.l.google.com:19302"
      },
      {
        urls: "turn:TURN_SERVER_URL", // Substitua pelo URL do seu servidor TURN, se necessário
        username: "username",  // Caso utilize autenticação para o servidor TURN
        credential: "password"
      }
    ];

    // Elementos de interface
    const startButton = document.getElementById('startButton');
    const remoteVideoContainer = document.getElementById('remoteVideoContainer');

    // Inicializa a captura de tela e estabelece a conexão
    async function captureScreen() {
      try {
        // Solicita permissão para capturar a tela
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        localStream.addTrack(stream.getTracks()[0]);

        // Cria um elemento de vídeo para exibir a tela local
        const localVideo = document.createElement('video');
        localVideo.srcObject = localStream;
        localVideo.autoplay = true;
        document.body.appendChild(localVideo);

        // Chama a função para criar uma oferta
        createOffer();
      } catch (err) {
        console.error("Erro ao capturar a tela:", err);
      }
    }

    // Cria a oferta e a envia para o Firebase
    async function createOffer() {
      try {
        peerConnection = new RTCPeerConnection({ iceServers });

        // Adiciona o fluxo local à conexão
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // Lida com candidatos ICE
        peerConnection.onicecandidate = event => {
          if (event.candidate) {
            sendIceCandidate(event.candidate);
          }
        };

        // Lida com o fluxo remoto
        peerConnection.ontrack = event => {
          if (event.streams && event.streams[0]) {
            remoteStream.addTrack(event.streams[0].getTracks()[0]);
          }
        };

        // Cria uma oferta de SDP
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        // Envia a oferta para o Firebase
        const offerData = {
          type: 'offer',
          sdp: offer.sdp
        };
        set(ref(database, 'sinalizacao'), offerData);
      } catch (err) {
        console.error("Erro ao criar a oferta:", err);
      }
    }

    // Lida com a oferta recebida
    function handleOffer(data) {
      const offer = new RTCSessionDescription({
        type: 'offer',
        sdp: data.sdp
      });
      peerConnection.setRemoteDescription(offer)
        .then(() => peerConnection.createAnswer())
        .then(answer => peerConnection.setLocalDescription(answer))
        .then(() => {
          const answerData = {
            type: 'answer',
            sdp: peerConnection.localDescription.sdp
          };
          set(ref(database, 'sinalizacao'), answerData);
        })
        .catch(err => console.error("Erro ao lidar com a oferta:", err));
    }

    // Lida com a resposta recebida
    function handleAnswer(data) {
      const answer = new RTCSessionDescription({
        type: 'answer',
        sdp: data.sdp
      });
      peerConnection.setRemoteDescription(answer)
        .catch(err => console.error("Erro ao lidar com a resposta:", err));
    }

    // Lida com o candidato ICE recebido
    function handleIceCandidate(candidate) {
      if (candidate && candidate.candidate) {
        try {
          const iceCandidate = new RTCIceCandidate({
            candidate: candidate.candidate,
            sdpMid: candidate.sdpMid || null,  // Se não tiver, coloca null
            sdpMLineIndex: candidate.sdpMLineIndex || null  // Se não tiver, coloca null
          });
          peerConnection.addIceCandidate(iceCandidate)
            .catch(err => console.error("Erro ao adicionar candidato ICE:", err));
        } catch (err) {
          console.error("Erro ao construir o candidato ICE:", err);
        }
      } else {
        console.error("Candidato ICE inválido recebido:", candidate);
      }
    }

    // Envia o candidato ICE para o Firebase
    function sendIceCandidate(candidate) {
      const iceCandidateData = {
        type: 'candidate',
        candidate: candidate.candidate,
        sdpMid: candidate.sdpMid || null,
        sdpMLineIndex: candidate.sdpMLineIndex || null
      };
      set(ref(database, 'sinalizacao'), iceCandidateData);
    }

    // Escuta mensagens de sinalização no Firebase
    function listenForSignalingMessages() {
      const signalRef = ref(database, 'sinalizacao');
      onValue(signalRef, snapshot => {
        const data = snapshot.val();
        if (data) {
          if (data.type === 'offer') {
            handleOffer(data);
          } else if (data.type === 'answer') {
            handleAnswer(data);
          } else if (data.type === 'candidate') {
            handleIceCandidate(data);
          }
        }
      });
    }

    // Inicia o compartilhamento de tela quando o botão é clicado
    startButton.addEventListener('click', captureScreen);

    // Começa a ouvir as mensagens de sinalização
    listenForSignalingMessages();
  </script>
</head>
<body>
  <h1>Compartilhamento de Tela entre Dispositivos</h1>
  <button id="startButton">Iniciar Compartilhamento de Tela</button>
  <div id="remoteVideoContainer"></div>
</body>
</html>
